<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Y2K DIGICAM STUDIO // ULTRA PRO V10.3 PHOTO-FIX</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&family=VT323&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #9d4edd;
            --accent-cyan: #00f0ff;
            --accent-pink: #ff00de;
            --accent-yellow: #ffee00;
            --lcd-orange: #ffaa00;
        }

        /* Prevent scrolling on mobile during interaction */
        html, body { 
            margin: 0; padding: 0; 
            height: 100%; overflow: hidden; 
            position: fixed; width: 100%;
            background-color: #e0e8ff;
            background-image: radial-gradient(var(--primary) 0.5px, transparent 0.5px);
            background-size: 20px 20px;
            font-family: 'Inter', sans-serif;
            display: flex; justify-content: center; align-items: center;
        }

        * { box-sizing: border-box; user-select: none; cursor: crosshair; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }

        /* Specific touch-action for sliders to prevent page scroll */
        input[type="range"] { touch-action: none; }

        @keyframes shake { 0% { transform: translate(0,0); } 25% { transform: translate(1px, 1px); } 50% { transform: translate(-1px, -1px); } 100% { transform: translate(0,0); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes print-slide { 0% { transform: translateY(-100%); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
        
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.03) 50%);
            background-size: 100% 4px; pointer-events: none; z-index: 9999;
        }

        .magazine-grid {
            width: 98vw; height: 95vh; max-width: 1600px;
            background: white; border: 4px solid #000; border-radius: 24px;
            box-shadow: 15px 15px 0px #000;
            display: grid; grid-template-columns: 320px 1fr 320px; grid-template-rows: 70px 1fr 50px;
            overflow: hidden; position: relative; animation: bounce-in 0.5s ease-out;
        }

        @keyframes bounce-in { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        @media (max-width: 1024px) {
            .magazine-grid { grid-template-columns: 1fr; grid-template-rows: 50px 1fr; height: 100vh; width: 100vw; border-radius: 0; border: none; }
            .sidebar { 
                position: absolute; left: -340px; top: 50px; height: calc(100% - 50px); 
                z-index: 2000; transition: 0.35s cubic-bezier(0.4, 0, 0.2, 1); width: 280px; border-right: 5px solid #000;
                background: white; box-shadow: 5px 0 15px rgba(0,0,0,0.2);
            }
            .sidebar.open { left: 0; }
            
            /* MOBILE DROPDOWN MEDIA ROLL IMPLEMENTATION */
            .right-bar { 
                position: absolute; bottom: 0; left: 0; width: 100%; height: auto; 
                max-height: 40px; z-index: 1500; transition: max-height 0.4s ease;
                border-left: none; border-top: 4px solid #000; background: #fff;
            }
            .right-bar.expanded { max-height: 70vh; }
            .mobile-roll-toggle { 
                display: flex !important; justify-content: center; align-items: center; 
                height: 36px; background: var(--accent-yellow); font-family: 'VT323'; font-size: 1.2rem; font-weight: bold; cursor: pointer; border: none; width: 100%;
            }
            .main-stage { order: 2; height: calc(100% - 90px); width: 100%; padding-bottom: 20px; }
            .footer { display: none !important; }
            .mobile-menu-btn { display: block !important; padding: 8px 12px !important; font-size: 1.1rem !important; }
            .logo { font-size: 1.6rem !important; }
            #bulkExport { padding: 6px 12px !important; font-size: 0.9rem !important; }
        }

        .header {
            grid-column: 1 / -1; background: repeating-linear-gradient(45deg, #fff, #fff 10px, #f0f0f0 10px, #f0f0f0 20px);
            display: flex; align-items: center; padding: 0 25px; border-bottom: 4px solid #000; justify-content: space-between; z-index: 10;
        }

        .mobile-menu-btn { display: none; background: #000; color: #fff; border: none; padding: 12px; font-size: 1.5rem; cursor: pointer; border-radius: 0 0 10px 0; }

        .logo { font-family: 'VT323', monospace; font-size: 2.5rem; color: #000; font-weight: 900; animation: shake 5s infinite linear; }

        .sidebar { background: #fff; border-right: 3px solid #000; padding: 20px; display: flex; flex-direction: column; gap: 8px; overflow-y: auto; -webkit-overflow-scrolling: touch; }

        .panel-header { font-family: 'VT323', monospace; font-size: 1.4rem; color: #fff; background: #000; padding: 6px 12px; border-radius: 4px; margin: 4px 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .panel-header:hover { transform: skewX(-5deg); background: var(--primary); }

        .control-group { margin-bottom: 8px; padding: 10px; border: 2px solid transparent; border-radius: 10px; transition: 0.2s; }
        .control-group:hover { border-color: #000; background: #fafafa; }
        .control-label { font-size: 0.7rem; font-weight: 900; color: #000; margin-bottom: 4px; display: flex; justify-content: space-between; text-transform: uppercase; }

        input[type="range"] { 
            -webkit-appearance: none; 
            width: 100%; 
            height: 12px; 
            background: #eee; 
            border: 2px solid #000; 
            border-radius: 10px; 
            outline: none; 
            margin: 12px 0; 
            cursor: pointer;
            pointer-events: auto;
        }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 28px; height: 28px; background: var(--accent-yellow); border: 2px solid #000; border-radius: 50%; cursor: pointer; box-shadow: 2px 2px 0px #000; transition: transform 0.1s; }
        input[type="range"]::-webkit-slider-thumb:active { transform: scale(1.2); background: var(--accent-pink); }
        
        input[type="date"] { width: 100%; padding: 5px; border: 2px solid #000; font-family: 'VT323'; font-size: 1rem; margin-top: 5px; }
        input[type="checkbox"] { width: 20px; height: 20px; border: 2px solid #000; accent-color: var(--accent-cyan); vertical-align: middle; }

        .main-stage { background: #111; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        
        #mediaContainer { position: relative; display: flex; justify-content: center; align-items: center; width: 100%; height: 100%; }
        canvas, video { box-shadow: 15px 15px 0px rgba(0,0,0,1); background: #000; max-width: 85vw; max-height: 70vh; cursor: pointer; object-fit: contain; }

        #videoWrapper {
            position: relative;
            display: none;
            overflow: hidden;
            box-shadow: 15px 15px 0px rgba(0,0,0,1);
        }

        .drop-zone { position: absolute; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #fff; z-index: 100; transition: transform 0.4s ease; }
        .drop-zone.hidden { transform: translateY(-100%); pointer-events: none; }

        .upload-btn { background: var(--accent-cyan); color: #000; font-family: 'VT323', monospace; font-size: 1.8rem; padding: 15px 40px; border: 4px solid #000; cursor: pointer; box-shadow: 6px 6px 0px #000; transition: 0.1s; }
        .upload-btn:active { transform: translate(3px, 3px); box-shadow: 2px 2px 0px #000; }

        .right-bar { background: #fff; border-left: 3px solid #000; display: flex; flex-direction: column; }
        .mobile-roll-toggle { display: none; }
        .file-list { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 8px; background: #f0f0f0; }
        .file-item { position: relative; display: flex; align-items: center; padding: 8px; border: 3px solid #000; font-size: 0.75rem; font-weight: 700; gap: 10px; cursor: pointer; background: white; transition: 0.2s; }
        .file-item.active { background: var(--accent-yellow); box-shadow: 4px 4px 0px #000; }
        .file-item img, .file-item video { width: 55px; height: 55px; object-fit: cover; border: 2px solid #000; }

        .delete-btn { position: absolute; top: -8px; right: -8px; background: #ff0000; color: white; border: 2px solid #000; border-radius: 50%; width: 24px; height: 24px; font-size: 14px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 5; }

        .footer { grid-column: 1 / -1; background: #000; color: #fff; display: flex; align-items: center; justify-content: space-between; padding: 0 25px; font-size: 0.75rem; }
        
        .mode-selector { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px; margin: 8px 0; }
        .mode-opt { border: 2px solid #000; padding: 6px; text-align: center; font-size: 0.7rem; font-weight: 900; cursor: pointer; background: #eee; transition: 0.2s; }
        .mode-opt.active { background: var(--accent-cyan); box-shadow: inset 2px 2px 0px #000; }

        #playbackIndicator { position: absolute; bottom: 20px; right: 20px; background: rgba(0,0,0,0.7); color: #fff; padding: 5px 10px; font-family: 'VT323'; font-size: 1.2rem; pointer-events: none; opacity: 0; transition: 0.3s; z-index: 100; }
        
        #videoDateOverlay {
            position: absolute; bottom: 4%; right: 4%;
            font-family: 'VT323', monospace; color: var(--lcd-orange);
            font-size: 2.2rem; font-weight: bold;
            text-shadow: 0 0 5px #ff5500, 2px 2px 0px rgba(0,0,0,0.8);
            pointer-events: none; display: none; z-index: 200;
        }

        #processingOverlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 5000;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            color: white;
        }
        .spinner {
            width: 60px; height: 60px; border: 6px solid rgba(255,255,255,0.2); border-top: 6px solid var(--accent-cyan);
            border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 20px;
        }

        .compare-btn {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9); border: 3px solid #000;
            padding: 12px 24px; font-family: 'VT323'; font-size: 1.4rem;
            cursor: pointer; z-index: 300; backdrop-filter: blur(4px);
            box-shadow: 5px 5px 0px rgba(0,0,0,1);
        }

        .add-more-btn {
            background: #000; color: #fff; border: 2px solid #fff;
            padding: 4px 8px; cursor: pointer; font-family: 'VT323';
            font-size: 1rem; margin-left: auto;
        }

        /* EXPORT MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 10000; display: none;
            justify-content: center; align-items: center; padding: 20px;
        }
        .modal-card {
            background: white; border: 5px solid #000; border-radius: 20px;
            max-width: 500px; width: 100%; padding: 30px; position: relative;
            box-shadow: 15px 15px 0px var(--accent-pink);
        }
        .modal-title { font-family: 'VT323'; font-size: 2.5rem; margin-bottom: 15px; color: #000; border-bottom: 4px solid #000; }
        .modal-btn { 
            width: 100%; padding: 15px; font-family: 'VT323'; font-size: 1.5rem; 
            border: 4px solid #000; cursor: pointer; background: var(--accent-cyan);
            box-shadow: 5px 5px 0px #000; margin-bottom: 10px;
        }
        .modal-btn.disabled { background: #ccc; cursor: not-allowed; opacity: 0.6; }

        .print-container {
            width: 100%; height: 300px; background: #222; border: 4px solid #000;
            margin-bottom: 20px; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center;
        }
        .print-animation { animation: print-slide 1.5s ease-out forwards; }
        
        .strip-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-height: 200px; overflow-y: auto; padding: 10px; border: 2px solid #000; margin-bottom: 15px; }
        .strip-item { border: 2px solid #000; cursor: pointer; position: relative; }
        .strip-item.selected { border-color: var(--accent-cyan); border-width: 4px; box-shadow: 0 0 10px var(--accent-cyan); }
        .strip-item img { width: 100%; height: 60px; object-fit: cover; }
    </style>
</head>
<body>

    <div class="scanlines"></div>

    <div id="exportModal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-title">SAVE OPTIONS</div>
            <div id="exportView1">
                <button class="modal-btn" onclick="triggerPrint('normal')">★ STANDARD DOWNLOAD</button>
                <button id="btnPolaroid" class="modal-btn" style="background:var(--accent-pink)" onclick="triggerPrint('polaroid')">★ POLAROID PRINT</button>
                <button id="btnStrip" class="modal-btn" style="background:var(--accent-yellow)" onclick="openStripSelection()">★ PHOTO BOOTH STRIP</button>
                <button class="modal-btn" style="background:#fff" onclick="closeExport()">CLOSE</button>
            </div>
            <div id="exportViewStrip" style="display:none">
                <div style="font-family:VT323; font-size:1.2rem; margin-bottom:5px;">SELECT 3 PHOTOS:</div>
                <div class="strip-selector" id="stripSelector"></div>
                <button class="modal-btn" onclick="triggerPrint('strip')">GENERATE STRIP</button>
                <button class="modal-btn" style="background:#fff" onclick="cancelStrip()">BACK</button>
            </div>
            <div id="exportViewPrint" style="display:none">
                <div class="print-container" id="printContainer"></div>
                <button class="modal-btn" id="dlConfirmBtn">DOWNLOAD NOW</button>
            </div>
        </div>
    </div>

    <div class="magazine-grid">
        <header class="header">
            <button class="mobile-menu-btn" onclick="toggleSidebar()">☰ MENU</button>
            <div class="logo">DIGICAMIFY PRO</div>
            <button id="bulkExport" class="upload-btn" style="font-size: 1.1rem; padding: 8px 20px; background: var(--accent-yellow);">ZIP ROLL</button>
        </header>

        <aside class="sidebar" id="sidebar">
            <div class="panel-header">★ MASTER FILTER</div>
            <div class="control-group">
                <div class="control-label"><span>INTENSITY</span> <span id="val-intensity">80%</span></div>
                <input type="range" id="intensity" min="0" max="100" value="80">
            </div>

            <div id="modeSection">
                <div class="panel-header">★ VIDEO MODE</div>
                <div class="mode-selector">
                    <div class="mode-opt active" data-mode="standard">STD</div>
                    <div class="mode-opt" data-mode="dreamy">DREAM</div>
                    <div class="mode-opt" data-mode="cctv">CCTV</div>
                </div>
            </div>

            <div class="panel-header">★ TIMESTAMP</div>
            <div class="control-group">
                <label style="font-family: 'VT323'; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; color: black;">
                    <input type="checkbox" id="showDate" checked> ENABLE STAMP
                </label>
                <input type="date" id="datePicker">
            </div>

            <div class="panel-header">★ IMAGE CONTROLS</div>
            <div class="control-group">
                <div class="control-label"><span>EXPOSURE</span> <span id="val-exposure">0</span></div>
                <input type="range" id="exposure" min="-100" max="100" value="0">
            </div>
            <div class="control-group">
                <div class="control-label"><span>SATURATION</span> <span id="val-saturation">100%</span></div>
                <input type="range" id="saturation" min="0" max="200" value="100">
            </div>
            <div class="control-group">
                <div class="control-label"><span>LENS BLUR</span> <span id="val-blur">0</span></div>
                <input type="range" id="blur" min="0" max="100" value="0">
            </div>

            <div class="panel-header">★ OPTICS</div>
            <div class="control-group">
                <div class="control-label"><span>BLOOM (GLOW)</span> <span id="val-glow">40</span></div>
                <input type="range" id="glow" min="0" max="100" value="40">
            </div>
            <div class="control-group">
                <div class="control-label"><span>ISO GRAIN</span> <span id="val-noise">30</span></div>
                <input type="range" id="noise" min="0" max="100" value="30">
            </div>

            <div class="panel-header">★ TRANSFORM</div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:5px;">
                <button class="mode-opt" style="background:white" onclick="rotateCurrent()">ROTATE 90°</button>
                <button class="mode-opt" style="background:#ffdddd" onclick="deleteCurrent()">DELETE</button>
            </div>
        </aside>

        <main class="main-stage" id="stage">
            <div id="processingOverlay">
                <div class="spinner"></div>
                <div id="processingText" style="font-family: 'VT323'; font-size: 2rem; letter-spacing: 2px;">IMPORTING MEDIA...</div>
            </div>

            <div id="playbackIndicator">PAUSED</div>
            
            <div class="drop-zone" id="dropZone">
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">UPLOAD PHOTOS/VIDEOS</button>
                <input type="file" id="fileInput" multiple accept="image/*,video/*" style="display:none">
            </div>

            <div id="mediaContainer">
                <canvas id="mainCanvas"></canvas>
                <div id="videoWrapper">
                    <video id="previewVideo" loop playsinline onclick="togglePlay()"></video>
                    <div id="videoDateOverlay">98 01 22</div>
                </div>
            </div>

            <button class="compare-btn" id="compareBtn" style="display:none;">HOLD TO COMPARE</button>
        </main>

        <aside class="right-bar" id="rightBar">
            <button class="mobile-roll-toggle" onclick="toggleMediaRoll()">★ MEDIA ROLL ▲</button>
            <div class="panel-header" style="margin: 10px; display: flex; align-items: center;">
                ★ MEDIA ROLL
                <button class="add-more-btn" onclick="document.getElementById('fileInput').click()">+ ADD</button>
            </div>
            <div class="file-list" id="fileList"></div>
            <div style="padding: 10px; border-top: 3px solid #000;">
                <button class="upload-btn" style="width:100%; font-size:1rem; background:var(--accent-pink)" onclick="openExport()">SAVE / PRINT</button>
            </div>
        </aside>

        <footer class="footer">
            <div style="font-family: 'VT323'; letter-spacing: 1px;">DIGICAMIFY // V10.3 PHOTO-OPT</div>
            <div id="statusInfo" id="storageStatus">STORAGE ACTIVE</div>
        </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script>
        let db = null;
        let isSessionMode = false;

        // FIXED DATABASE INITIALIZATION FOR INCOGNITO/PRODUCTION
        const request = indexedDB.open("DigicamStudioDB", 2);
        request.onupgradeneeded = (e) => {
            const upgradeDb = e.target.result;
            if(!upgradeDb.objectStoreNames.contains("media")) {
                upgradeDb.createObjectStore("media", { keyPath: "id", autoIncrement: true });
            }
        };
        request.onsuccess = (e) => {
            db = e.target.result;
            loadFromDatabase();
        };
        request.onerror = (e) => {
            console.warn("IndexedDB blocked (Incognito Mode). Switching to Session Mode.");
            isSessionMode = true;
            document.getElementById('statusInfo').innerText = "SESSION MODE (NO SAVE)";
        };

        const state = {
            media: [],
            selectedIndex: -1,
            selectedStripIds: [],
            mode: 'standard',
            isComparing: false,
            settings: { 
                intensity: 80, 
                exposure: 0, 
                saturation: 100, 
                blur: 0, 
                glow: 40, 
                noise: 30,
                showDate: true,
                dateValue: new Date().toISOString().split('T')[0]
            }
        };

        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const videoEl = document.getElementById('previewVideo');
        const videoWrapper = document.getElementById('videoWrapper');
        const processingEl = document.getElementById('processingOverlay');
        const dateOverlayEl = document.getElementById('videoDateOverlay');
        const compareBtn = document.getElementById('compareBtn');

        function init() {
            document.getElementById('datePicker').value = state.settings.dateValue;

            document.querySelectorAll('input[type="range"]').forEach(slider => {
                const updateHandler = (e) => {
                    const id = e.target.id;
                    const val = parseInt(e.target.value);
                    state.settings[id] = val;
                    const label = document.getElementById('val-'+id);
                    if(label) label.innerText = val + (id === 'saturation' || id === 'intensity' ? '%' : '');
                    refreshView();
                };
                slider.addEventListener('input', updateHandler);
                slider.addEventListener('change', updateHandler);
            });

            document.getElementById('showDate').onchange = (e) => {
                state.settings.showDate = e.target.checked;
                refreshView();
            };

            document.getElementById('datePicker').onchange = (e) => {
                state.settings.dateValue = e.target.value;
                refreshView();
            };

            document.querySelectorAll('[data-mode]').forEach(opt => {
                opt.onclick = () => {
                    document.querySelectorAll('[data-mode]').forEach(o => o.classList.remove('active'));
                    opt.classList.add('active');
                    state.mode = opt.dataset.mode;
                    refreshView();
                };
            });

            compareBtn.addEventListener('mousedown', (e) => { state.isComparing = true; refreshView(); });
            compareBtn.addEventListener('touchstart', (e) => { e.preventDefault(); state.isComparing = true; refreshView(); });
            window.addEventListener('mouseup', () => { state.isComparing = false; refreshView(); });
            window.addEventListener('touchend', () => { state.isComparing = false; refreshView(); });
        }

        /* MOBILE ROLL UI */
        function toggleMediaRoll() { document.getElementById('rightBar').classList.toggle('expanded'); }

        function openExport() {
            if (state.selectedIndex === -1) return;
            const currentItem = state.media[state.selectedIndex];
            
            if (currentItem.type === 'video') {
                document.getElementById('btnPolaroid').classList.add('disabled');
                document.getElementById('btnStrip').classList.add('disabled');
                document.getElementById('btnPolaroid').onclick = null;
                document.getElementById('btnStrip').onclick = null;
            } else {
                document.getElementById('btnPolaroid').classList.remove('disabled');
                document.getElementById('btnStrip').classList.remove('disabled');
                document.getElementById('btnPolaroid').onclick = () => triggerPrint('polaroid');
                document.getElementById('btnStrip').onclick = openStripSelection;
            }

            document.getElementById('exportView1').style.display = 'block';
            document.getElementById('exportViewStrip').style.display = 'none';
            document.getElementById('exportViewPrint').style.display = 'none';
            document.getElementById('exportModal').style.display = 'flex';
        }

        function closeExport() { document.getElementById('exportModal').style.display = 'none'; }

        function openStripSelection() {
            const selector = document.getElementById('stripSelector');
            selector.innerHTML = '';
            state.selectedStripIds = [];
            
            state.media.filter(m => m.type === 'image').forEach(m => {
                const div = document.createElement('div');
                div.className = 'strip-item';
                div.innerHTML = `<img src="${m.src}">`;
                div.onclick = () => {
                    if (state.selectedStripIds.includes(m.id)) {
                        state.selectedStripIds = state.selectedStripIds.filter(id => id !== m.id);
                        div.classList.remove('selected');
                    } else if (state.selectedStripIds.length < 3) {
                        state.selectedStripIds.push(m.id);
                        div.classList.add('selected');
                    }
                };
                selector.appendChild(div);
            });
            document.getElementById('exportView1').style.display = 'none';
            document.getElementById('exportViewStrip').style.display = 'block';
        }

        function cancelStrip() {
            document.getElementById('exportViewStrip').style.display = 'none';
            document.getElementById('exportView1').style.display = 'block';
        }

        async function triggerPrint(type) {
            const container = document.getElementById('printContainer');
            container.innerHTML = '';
            document.getElementById('exportView1').style.display = 'none';
            document.getElementById('exportViewStrip').style.display = 'none';
            document.getElementById('exportViewPrint').style.display = 'block';

            let outputUrl = "";
            if (type === 'normal') {
                const item = state.media[state.selectedIndex];
                outputUrl = item.type === 'video' ? item.src : canvas.toDataURL('image/jpeg', 0.9);
                const preview = document.createElement('img');
                preview.src = outputUrl;
                preview.style.maxWidth = '80%';
                preview.className = 'print-animation';
                container.appendChild(preview);
            } else if (type === 'polaroid') {
                const pCanvas = document.createElement('canvas');
                const pCtx = pCanvas.getContext('2d');
                pCanvas.width = 400; pCanvas.height = 500;
                pCtx.fillStyle = "white"; pCtx.fillRect(0,0,400,500);
                pCtx.drawImage(canvas, 20, 20, 360, 360);
                outputUrl = pCanvas.toDataURL('image/jpeg');
                const preview = document.createElement('div');
                preview.style.background = "white"; preview.style.padding = "10px 10px 40px 10px";
                preview.innerHTML = `<img src="${outputUrl}" style="width:200px; border:1px solid #ddd">`;
                preview.className = 'print-animation';
                container.appendChild(preview);
            } else if (type === 'strip') {
                if (state.selectedStripIds.length < 1) return alert("Select photos first!");
                const sCanvas = document.createElement('canvas');
                const sCtx = sCanvas.getContext('2d');
                sCanvas.width = 300; sCanvas.height = 800;
                sCtx.fillStyle = "white"; sCtx.fillRect(0,0,300,800);
                state.selectedStripIds.forEach((id, idx) => {
                    const m = state.media.find(item => item.id === id);
                    sCtx.drawImage(m.img, 20, 20 + (idx * 250), 260, 240);
                });
                outputUrl = sCanvas.toDataURL('image/jpeg');
                const preview = document.createElement('img');
                preview.src = outputUrl; preview.style.height = '280px';
                preview.className = 'print-animation';
                container.appendChild(preview);
            }

            document.getElementById('dlConfirmBtn').onclick = () => {
                const link = document.createElement('a');
                link.download = `DIGI_EXPORT_${Date.now()}.jpg`;
                link.href = outputUrl;
                link.click();
                closeExport();
            };
        }

        async function loadFromDatabase() {
            if (!db) return;
            const transaction = db.transaction(["media"], "readonly");
            const store = transaction.objectStore("media");
            const request = store.getAll();
            request.onsuccess = async () => {
                const results = request.result;
                if(results.length > 0) {
                    document.getElementById('dropZone').classList.add('hidden');
                    showProcessing(true, "RELOADING GALLERY...");
                    for(let data of results) {
                        const blob = data.file;
                        const url = URL.createObjectURL(blob);
                        const obj = { id: data.id, type: data.type, src: url, name: data.name, rotation: data.rotation || 0 };
                        if (obj.type === 'image') {
                            obj.img = await new Promise(r => { 
                                const i = new Image(); 
                                i.onload = () => r(i); 
                                i.onerror = () => r(null);
                                i.src = url; 
                            });
                        }
                        state.media.push(obj);
                    }
                    updateQueue();
                    selectMedia(state.media.length - 1);
                    showProcessing(false);
                    compareBtn.style.display = 'block';
                }
            };
        }

        function refreshView() {
            if (state.selectedIndex !== -1) {
                const item = state.media[state.selectedIndex];
                if (item.type === 'video') {
                    document.getElementById('modeSection').style.display = 'block';
                    applyVideoFX();
                } else {
                    document.getElementById('modeSection').style.display = 'none'; 
                    render();
                }
            }
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

        function togglePlay() {
            if (videoEl.paused) { videoEl.muted = false; videoEl.play(); showIndicator("PLAYING"); } 
            else { videoEl.pause(); showIndicator("PAUSED"); }
        }

        function showIndicator(text) {
            const ind = document.getElementById('playbackIndicator');
            ind.innerText = text; ind.style.opacity = 1;
            setTimeout(() => { if(ind.innerText === text) ind.style.opacity = 0; }, 1200);
        }

        function showProcessing(show, text = "DEVELOPING...") {
            document.getElementById('processingText').innerText = text;
            processingEl.style.display = show ? 'flex' : 'none';
        }

        function formatDisplayDate(dateStr) {
            if(!dateStr) return "'00 00 00";
            const d = new Date(dateStr);
            const yy = d.getFullYear().toString().slice(-2);
            const mm = (d.getMonth() + 1).toString().padStart(2, '0');
            const dd = d.getDate().toString().padStart(2, '0'); 
            return `'${yy} ${mm} ${dd}`;
        }

        document.getElementById('fileInput').onchange = async (e) => {
            const files = Array.from(e.target.files);
            if(files.length === 0) return;
            document.getElementById('dropZone').classList.add('hidden');
            showProcessing(true, "PROCESSING MEDIA...");
            
            const filePromises = files.map(file => {
                return new Promise(async (resolve) => {
                    const type = file.type.startsWith('video') ? 'video' : 'image';
                    const url = URL.createObjectURL(file);
                    
                    const finishFile = async (id) => {
                        const obj = { id, type, src: url, name: file.name, rotation: 0 };
                        if (type === 'image') {
                            obj.img = await new Promise(r => { 
                                const i = new Image(); 
                                i.onload = () => r(i); 
                                i.onerror = () => r(null);
                                i.src = url; 
                            });
                        }
                        state.media.push(obj);
                        resolve();
                    };

                    if (isSessionMode || !db) {
                        await finishFile(Date.now() + Math.random());
                    } else {
                        try {
                            const transaction = db.transaction(["media"], "readwrite");
                            const store = transaction.objectStore("media");
                            const addReq = store.add({ type, file, name: file.name, rotation: 0 });
                            addReq.onsuccess = (ev) => finishFile(ev.target.result);
                            addReq.onerror = () => finishFile(Date.now() + Math.random());
                        } catch(err) {
                            await finishFile(Date.now() + Math.random());
                        }
                    }
                });
            });

            // Decoupled resolution: Ensure UI clears even if specific files hang
            Promise.allSettled(filePromises).finally(() => {
                setTimeout(() => {
                    finishUpload();
                }, 100);
            });

            // Global safety timeout
            setTimeout(() => {
                if (processingEl.style.display === 'flex') finishUpload();
            }, 10000);
        };

        function finishUpload() {
            updateQueue();
            selectMedia(state.media.length - 1);
            showProcessing(false);
            compareBtn.style.display = 'block';
        }

        function selectMedia(index) {
            if (index < 0) return;
            state.selectedIndex = index;
            const item = state.media[index];
            if (item.type === 'video') {
                canvas.style.display = 'none';
                videoWrapper.style.display = 'flex';
                videoEl.src = item.src;
                videoEl.load();
                videoEl.play().catch(() => {});
                refreshView();
            } else {
                videoEl.pause();
                videoWrapper.style.display = 'none';
                canvas.style.display = 'block';
                refreshView();
            }
            updateQueue();
        }

        function render() {
            const item = state.media[state.selectedIndex];
            if (!item || item.type !== 'image' || !item.img) return;
            const s = state.settings;
            const masterMix = state.isComparing ? 0 : (s.intensity / 100);
            
            const isRotated = (item.rotation / 90) % 2 !== 0;
            canvas.width = isRotated ? item.img.height : item.img.width;
            canvas.height = isRotated ? item.img.width : item.img.height;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(canvas.width/2, canvas.height/2);
            ctx.rotate((item.rotation * Math.PI) / 180);
            ctx.translate(-item.img.width/2, -item.img.height/2);

            let filters = `brightness(${1 + (s.exposure/40 * masterMix)}) saturate(${100 + ((s.saturation - 100) * 2.2 * masterMix)}%) blur(${(s.blur / 10) * masterMix}px)`;
            filters += ` contrast(${100 + (25 * masterMix)}%) sepia(${15 * masterMix}%)`;
            
            ctx.filter = filters;
            ctx.drawImage(item.img, 0, 0);

            if (!state.isComparing) {
                if (s.glow > 0) {
                    ctx.globalCompositeOperation = 'screen'; 
                    ctx.globalAlpha = (s.glow / 120) * masterMix; 
                    ctx.filter = `blur(${20 * masterMix}px) brightness(1.3)`;
                    ctx.drawImage(item.img, 0, 0);
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.globalAlpha = 1.0;
                }
                if (s.noise > 0) {
                    ctx.globalCompositeOperation = 'overlay'; 
                    ctx.globalAlpha = (s.noise / 100) * masterMix;
                    const pCanvas = document.createElement('canvas'); 
                    pCanvas.width = 128; pCanvas.height = 128;
                    const pCtx = pCanvas.getContext('2d');
                    const imgData = pCtx.createImageData(128, 128);
                    for(let i=0; i<imgData.data.length; i+=4) {
                        const v = (Math.random() * 255) | 0;
                        imgData.data[i] = v; imgData.data[i+1] = v; imgData.data[i+2] = v; imgData.data[i+3] = 255; 
                    }
                    pCtx.putImageData(imgData, 0, 0); 
                    ctx.fillStyle = ctx.createPattern(pCanvas, 'repeat');
                    ctx.fillRect(0, 0, item.img.width, item.img.height);
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.globalAlpha = 1.0;
                }
                if (s.showDate) {
                    ctx.restore(); ctx.save();
                    ctx.translate(canvas.width/2, canvas.height/2); 
                    ctx.rotate((item.rotation * Math.PI) / 180);
                    ctx.translate(-item.img.width/2, -item.img.height/2);
                    ctx.fillStyle = '#ffaa00'; 
                    ctx.font = `bold ${Math.max(14, item.img.height * 0.045)}px "VT323", monospace`;
                    ctx.shadowColor = '#ff5500'; 
                    ctx.shadowBlur = 4; 
                    ctx.textAlign = 'right';
                    ctx.fillText(formatDisplayDate(s.dateValue), item.img.width * 0.94, item.img.height * 0.92);
                }
            }
            ctx.restore();
        }

        function applyVideoFX() {
            if (state.selectedIndex === -1 || state.media[state.selectedIndex].type !== 'video') return;
            const s = state.settings;
            const master = state.isComparing ? 0 : (s.intensity / 100);
            let vFilter = `brightness(${1 + (s.exposure/40 * master)}) saturate(${100 + ((s.saturation-100) * 2.2 * master)}%) blur(${(s.blur / 10) * master}px)`;
            if (state.mode === 'standard') vFilter += ` contrast(${100 + (25 * master)}%) sepia(${15 * master}%)`;
            if (state.mode === 'cctv') vFilter += ` grayscale(${100 * master}%) contrast(200%) brightness(120%)`;
            if (state.mode === 'dreamy' && master > 0) vFilter += ` saturate(150%) brightness(110%)`;
            if (s.glow > 0) vFilter += ` drop-shadow(0 0 ${10*master}px rgba(255,255,255,0.5))`;
            videoEl.style.filter = vFilter;
            videoWrapper.style.transform = `rotate(${state.media[state.selectedIndex].rotation}deg)`;
            dateOverlayEl.style.display = (s.showDate && !state.isComparing) ? 'block' : 'none';
            dateOverlayEl.innerText = formatDisplayDate(s.dateValue);
            if (!videoEl.paused) requestAnimationFrame(applyVideoFX);
        }

        function rotateCurrent() {
            if(state.selectedIndex === -1) return;
            state.media[state.selectedIndex].rotation = (state.media[state.selectedIndex].rotation + 90) % 360;
            refreshView();
        }

        function deleteCurrent() {
            if(state.selectedIndex === -1) return;
            const idToDelete = state.media[state.selectedIndex].id;
            if (!isSessionMode && db) {
                const tx = db.transaction(["media"], "readwrite");
                tx.objectStore("media").delete(idToDelete);
            }
            state.media.splice(state.selectedIndex, 1);
            state.selectedIndex = state.media.length - 1;
            updateQueue();
            if(state.selectedIndex !== -1) selectMedia(state.selectedIndex);
            else {
                document.getElementById('dropZone').classList.remove('hidden');
                videoWrapper.style.display='none'; canvas.style.display='none'; compareBtn.style.display='none';
            }
        }

        function updateQueue() {
            const list = document.getElementById('fileList');
            list.innerHTML = '';
            state.media.forEach((m, i) => {
                const div = document.createElement('div');
                div.className = `file-item ${i === state.selectedIndex ? 'active' : ''}`;
                div.innerHTML = `<div class="delete-btn" onclick="event.stopPropagation(); deleteIdx(${i})">×</div>${m.type==='image' ? `<img src="${m.src}">` : `<video src="${m.src}"></video>`}<span>${m.name.substring(0,10)}</span>`;
                div.onclick = () => { selectMedia(i); if(window.innerWidth <= 1024) toggleMediaRoll(); };
                list.appendChild(div);
            });
        }

        function deleteIdx(i) {
            const idToDelete = state.media[i].id;
            if (!isSessionMode && db) {
                const tx = db.transaction(["media"], "readwrite");
                tx.objectStore("media").delete(idToDelete);
            }
            state.media.splice(i, 1); 
            updateQueue(); 
            if(i === state.selectedIndex) deleteCurrent();
        }

        document.getElementById('bulkExport').onclick = async () => {
            if (state.media.length === 0) return;
            showProcessing(true, "ZIPPING GALLERY...");
            const zip = new JSZip();
            setTimeout(async () => {
                for(let m of state.media) {
                    if(m.type === 'image' && m.img) {
                        const tempCanvas = document.createElement('canvas'); const tempCtx = tempCanvas.getContext('2d');
                        const s = state.settings; const masterMix = s.intensity / 100;
                        const isRotated = (m.rotation / 90) % 2 !== 0;
                        tempCanvas.width = isRotated ? m.img.height : m.img.width;
                        tempCanvas.height = isRotated ? m.img.width : m.img.height;
                        tempCtx.translate(tempCanvas.width/2, tempCanvas.height/2);
                        tempCtx.rotate((m.rotation * Math.PI) / 180);
                        tempCtx.translate(-m.img.width/2, -m.img.height/2);
                        tempCtx.filter = `brightness(${1+(s.exposure/40*masterMix)}) saturate(${100+((s.saturation-100)*2.2*masterMix)}%) blur(${(s.blur/10)*masterMix}px)`;
                        tempCtx.drawImage(m.img, 0, 0);
                        const blob = await new Promise(r => tempCanvas.toBlob(r, 'image/jpeg', 0.9));
                        zip.file(m.name, blob);
                    } else {
                        try {
                            const response = await fetch(m.src);
                            const videoBlob = await response.blob();
                            zip.file(m.name, videoBlob);
                        } catch(e) {}
                    }
                }
                const content = await zip.generateAsync({type:"blob"});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = "DIGICAM_BATCH.zip";
                link.click();
                showProcessing(false);
            }, 100);
        };

        init();
    </script>
</body>
</html>
